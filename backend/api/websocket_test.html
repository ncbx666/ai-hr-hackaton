<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test - AI-HR Interview</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .message { background-color: #f0f8ff; padding: 10px; margin: 5px 0; border-radius: 3px; }
        button { padding: 10px 15px; margin: 5px; font-size: 16px; }
        #messages { height: 400px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; }
    </style>
</head>
<body>
    <h1>ü§ñ AI-HR Interview WebSocket Test</h1>
    
    <div id="status" class="status disconnected">‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
    
    <button onclick="connect()">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <button onclick="disconnect()">üîå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <button onclick="endInterview()">‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é</button>
    
    <h3>–°–æ–æ–±—â–µ–Ω–∏—è:</h3>
    <div id="messages"></div>
    
    <script>
        let ws = null;
        const sessionId = "test-session-" + Date.now();
        
        function updateStatus(connected, message) {
            const statusDiv = document.getElementById('status');
            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.innerHTML = '‚úÖ ' + message;
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.innerHTML = '‚ùå ' + message;
            }
        }
        
        function addMessage(type, content) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}] ${type}:</strong> ${content}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addMessage('INFO', '–£–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ');
                return;
            }
            
            const wsUrl = `ws://localhost:8001/ws/interview/${sessionId}`;
            addMessage('INFO', `–ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ ${wsUrl}...`);
            updateStatus(false, '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                updateStatus(true, '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ WebSocket');
                addMessage('SUCCESS', 'WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–Ω–¥–∏–¥–∞—Ç–µ
                setTimeout(() => {
                    const candidateInfo = {
                        type: 'candidate_info',
                        name: '–¢–µ—Å—Ç–æ–≤—ã–π –ö–∞–Ω–¥–∏–¥–∞—Ç'
                    };
                    ws.send(JSON.stringify(candidateInfo));
                    addMessage('SENT', '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–Ω–¥–∏–¥–∞—Ç–µ');
                }, 1000);
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    addMessage('RECEIVED', `–¢–∏–ø: ${data.type}, –°–æ–æ–±—â–µ–Ω–∏–µ: ${data.message || 'N/A'}`);
                    
                    if (data.type === 'question') {
                        addMessage('QUESTION', `–í–æ–ø—Ä–æ—Å ${data.question_number}: ${data.message}`);
                        
                        // –°–∏–º—É–ª–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(() => {
                            if (ws && ws.readyState === WebSocket.OPEN) {
                                const response = {
                                    type: 'audio_chunk',
                                    data: 'fake_audio_data',
                                    size: 1024
                                };
                                ws.send(JSON.stringify(response));
                                addMessage('SENT', '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–∏–º—É–ª—è—Ü–∏–æ–Ω–Ω—ã–π –∞—É–¥–∏–æ –æ—Ç–≤–µ—Ç');
                            }
                        }, 3000);
                    }
                } catch (e) {
                    addMessage('ERROR', '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + e.message);
                }
            };
            
            ws.onclose = function(event) {
                updateStatus(false, '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
                addMessage('INFO', `–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ. –ö–æ–¥: ${event.code}, –ü—Ä–∏—á–∏–Ω–∞: ${event.reason}`);
            };
            
            ws.onerror = function(error) {
                updateStatus(false, '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                addMessage('ERROR', '–û—à–∏–±–∫–∞ WebSocket: ' + error);
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                addMessage('INFO', '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ –≤—Ä—É—á–Ω—É—é');
            }
        }
        
        function endInterview() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const endMessage = {
                    type: 'end_interview'
                };
                ws.send(JSON.stringify(endMessage));
                addMessage('SENT', '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏–Ω—Ç–µ—Ä–≤—å—é');
            } else {
                addMessage('ERROR', 'WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            addMessage('INFO', '–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, session ID: ' + sessionId);
            setTimeout(connect, 1000);
        };
    </script>
</body>
</html>
